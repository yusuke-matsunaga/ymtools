# ymtools のビルドについて

<div style="text-align:right;">
松永　裕介<br>
????.??.?? Ver.1<br>
2013.11.20 Ver.2<br>
2015.03.07 Ver.3<br>
2015.07.22 Ver.3.1<br>
</div>

## はじめに
ymtools は cmake を用いて Makefile の生成を行います．
そのためビルドの流れが以前に比べて単純になりました．
大まかな流れは以下のとおりです．

  1. [ビルドに必要なツールのインストール](#1-ビルドに必要なツールのインストール)
  2. [cmake の実行](#2-cmake-の実行)
  3. [mk_builddir.sh スクリプト](#3-mk_builddirsh-スクリプト)
  4. [do_cmake.sh スクリプト](#4-do_cmakesh-スクリプト)
  5. [make の実行](#5-make-の実行)
  6. [make test の実行](#6-make-test-の実行)
  7. [make install の実行](#7-make-install-の実行)

このうち 1. は PC 上のソフトウェア開発環境を一回インストールすれば以降
は必要ありません．たまにソフトウェアのバージョンアップが必要になるかも
しれません．
2. も通常は最初に一回だけ行えばよいですが，新たにソースファイルを追加
した時などにも実行する必要があります．
3. の mk_builddir.sh スクリプト と 4. の do_cmake.sh スクリプト
は上記の手順を行うシェルスクリプトです．
特に複雑なことはしていませんが，毎回手でコマンドを打ち込むのは
面倒なのでこのようなスクリプトを用意しています．
5. はソースファイルに変更があった時には毎回実行します．
6. は自動テストです．
7. はコンパイルしたバイナリやライブラリ，ヘッダファイルをインストールします．


### ディレクトリ構成
ymtools をコンパイル・インストールする際に以下のような3種類のディレクトリを使います．
- ソースディレクトリ

ソースファイル(git のリポジトリ)があるディレクトリです．
 mk_builddir.sh はここで実行します．

- ビルドディレクトリ

コンパイルを行うディレクトリです．
コンパイル結果のファイルなどがここに生成されます．
cmake コマンドはここで実行します．
cmake コマンドを起動する do_cmake.sh スクリプトも同様です．

- インストールディレクトリ

最終的な実行バイナリやライブラリ，ヘッダファイルがインストールされるディレクトリです．
もちろん，このデイレクトリに対する書き込み許可を持っていなければインストールできません．


##1. ビルドに必要なツールのインストール

ymtools のビルドに必要なツールは以下のとおりです．

- cmake
- gcc/g++ もしくは clang/clang++
- yacc (bison)
- google-test
- google-perftools

あったほうが良いパッケージは以下のとおりです．
- popt

今回，tcl, python や readline/curses に依存しないようにしました．

以下に個々のツールについて補足します．

- cmake
 現在，FreeBSD-10.1Release の cmake-3.1.3 を用いています．たぶん，
 cmake 3.X なら大丈夫だと思います．

- gcc/g++ もしくは clang/clang++
 現在，FreeBSD-10.1Release の clang-3.4.1 を用いています．
 たぶん gcc-4.7 以降でも動くと思います．

- yacc (bison)
 現在，bison-2.4.3, bison-2.5 でテストしています．
bison を yacc 互換で動かすためには bison -y とします．
bison-1.X.X では %define api.pure ディレクティブを理解してくれないの
で動きません．

- popt
 現在，popt-1.16 でテストしています．


###1.1. 上記ツールがインストールされていない場合の対処

一番簡単なのは，計算機の管理者にいって，上記のツールの最新バージョンを
インストールしてもらうことですが，それが難しい場合には自分でソースをもっ
てきて，configure; make; make install する必要があります．
その場合，ymtools 用のディレクトリを用意してそこにこれら一連のツールを
インストールすることをおすすめします．例えば，ymtools 用に，
`~/proj/ymtools` というディレクトリを用意したとします．
例えば，bison をインストールする際に，bison のソースディレクトリに移って，
~~~shell
$ ./configure --prefix=~/proj/ymtools
$ make
$ make install
~~~
とすれば，`~/proj/ymtools/bin/bison` などがインストールされます．

これら，自分でインストールしたツールを ymtools のビルドに使う場合の指
定の仕方ですが，種類によって違いがあります．

- 実行ファイル
  これは実行時に shell が検索できるように環境変数 PATH に `~/proj/ymtools/bin`
  を加えておいてください．

- ヘッダファイル/ライブラリファイル
  現在，popt のみですが，これは cmake が popt パッケージを見つけるための
  FindPOPT.cmake 中でどう書いてあるかに依存します．
  正直，popt はどうでもいいのであまり調べていません．

別件ですが，YmTools のインストール先を上記のディレクトリと同じにしておくと
いろいろと便利なことがありません．たぶん，実行ファイルやライブラリファイルを
デフォルトで見つけてくれると思います．


##2. cmake の実行

cmake の仕事は Cコンパイラなどのビルドツールの確認や必要なライブラリの
検索などを行って Makefile を生成することです．
ですのでソースファイルを追加したり，リンクするライブラリを追加したりす
るような Makefile に変更される場合には cmake を実行する必要があります．
逆に，ソースファイルの内容だけが変更された場合には Makefile の変更はあ
りませんので cmake を実行する必要はありません．

cmake はコンパイラやライブラリの場所や名前を巧妙な方法で探します．ライ
ブラリなどをデフォルトの位置にインストールしている場合にはほとんど何の
指定もせずに見つけてくれますが，自分のホームディレクトリの下にインストー
ルした場合などには cmake に位置を教える必要があります．
具体的な方法は cmake のマニュアルで調べてください．
通常，これらの指定は最初の一回だけ行えば，2回め以降は省略可能です．

[***重要***]
cmake はソースディレクトリ上で実行することも可能ですが，ソースディレク
トリはバージョン管理されたファイルが存在しますので，ビルド用の一時ファ
イルやコンパイル結果のファイルなどでソースディレクトリが汚れてしまうこ
とはあまり好ましいことではありません．たとえば git add ./* などとして
しまうと .gitignore で明示的に除外しておかない限りそのディレクトリにあ
るファイルがすべてバージョン管理の対象となってしまいます．
そこで，ビルド用に別のディレクトリを用意し，そこにコンパイル結果のファ
イルを置くことが一般的です．これは automake/autoconf でも同様です．
やりかたは極めて簡単です．今，ソースディレクトリを $(SRC_DIR) ビルドディ
レクトリを $(BUILD_DIR) とします．すると cmake の実行は以下のような手
順で行います．
~~~shell
$ mkdir -p $(BUILD_DIR)
$ cd $(BUILD_DIR)
$ cmake $(SRC_DIR)
~~~
これで $(BUILD_DIR) 以下に Makefile といくつかの作業用ディレクトリが生
成されます．


##3. mk_builddir.sh スクリプト

ビルドディレクトリの用意と毎回の cmake の実行を行うスクリプトの生成
を行うためのスクリプトを作りました．
ソースディレクトリで
~~~
$ mk_builddir.sh <ビルドディレクトリ> <インストールディレクトリ>
~~~
を実行すると
~~~
****
source  directory: XXX
build   directory: XXX
install directory: XXX
****
continue ? (yes/no)
~~~
という表示が出ますので問題なければ yes と入力してください．
その後，<ビルドディレクトリ>　直下に do_cmake.sh というシェルスクリプト
が生成され，ビルドディレクトリで
~~~
$ ./do_cmake.sh
~~~
が実行されます．

##4. do_cmake.sh スクリプト

do_cmake は簡単なシェルスクリプトで毎回同じ cmake の引数を手でタイプ
しなくて済むためのものです．cmake の引数にオプションを加えたい場合は
直接 cmake コマンドを手で入力するか do_cmake スクリプトを書き換えて
ください．

通常はこの do_cmake.sh スクリプトは一回，実行するだけで良いのですが，
ソースファイルを追加したり，リンクするライブラリを追加した場合には
Makefile を作りなおす必要がありますのでこの do_cmake.sh を再実行
してください(というか複数回，実行することのないものをスクリプトには
しません)．


##5. make の実行

cmake で問題が起こっていない限りあとは make とタイプするだけですべての
ビルドが完了します．
ソースファイルに変更を加えただけなら cmake の実行は必要ありません．
make だけでOKです．


##6. make test の実行

まだすごく不十分ですが，テストコードを作っています．
make が終わったら
~~~shell
make test
~~~
で各ライブラリのテストを行ってください．
現在は CTest (cmake のテストツール)と google-test ライブラリを用いて
います．このような枠組みは CppUnit とか CppUtest とかいろいろあって
いろいろ試しているのですが，現在は CTest と google-test になっています．
具体的には個々のライブラリのディレクトリ直下に gtest というディレクトリ
があってその下にテスト用のバイナリがあります．
それを直接実行すると詳細なテスト出力が読めます．

##7. make install の実行

エラーがなければ最後に

~~~
$ make install
~~~

を実行すればインストールディレクトリにファイルがインストールされます．
インストールディレクトリが存在しない場合，作成されますのでスペルミスする
とエラーとならずに新しいディレクトリを作ってしまうので注意してください．
